#!/usr/bin/env python3
"""
Archive old log files
Compresses and moves logs to archive directory
"""

import gzip
import shutil
from pathlib import Path
from datetime import datetime

PROJECT_ROOT = Path(__file__).parent.parent
LOGS_DIR = PROJECT_ROOT / "data" / "logs"
ARCHIVE_DIR = LOGS_DIR / "archive"

def create_archive_dir():
    """Create archive directory if it doesn't exist"""
    ARCHIVE_DIR.mkdir(exist_ok=True)
    print(f"ðŸ“ Archive directory: {ARCHIVE_DIR}")

def archive_log(log_path):
    """Archive a single log file"""
    if not log_path.exists():
        print(f"âš ï¸  {log_path.name} not found, skipping")
        return False
    
    # Check if file is large enough to archive (>1MB)
    size_mb = log_path.stat().st_size / (1024 * 1024)
    
    if size_mb < 1:
        print(f"â„¹ï¸  {log_path.name} is small ({size_mb:.2f}MB), skipping")
        return False
    
    # Create archive filename with timestamp
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    archive_name = f"{log_path.stem}_{timestamp}.log.gz"
    archive_path = ARCHIVE_DIR / archive_name
    
    # Compress and save
    print(f"ðŸ“¦ Archiving {log_path.name} ({size_mb:.2f}MB)...")
    
    with open(log_path, 'rb') as f_in:
        with gzip.open(archive_path, 'wb') as f_out:
            shutil.copyfileobj(f_in, f_out)
    
    # Get compressed size
    compressed_size_mb = archive_path.stat().st_size / (1024 * 1024)
    compression_ratio = (1 - compressed_size_mb / size_mb) * 100
    
    print(f"âœ“ Archived to {archive_name}")
    print(f"  Original: {size_mb:.2f}MB â†’ Compressed: {compressed_size_mb:.2f}MB")
    print(f"  Compression: {compression_ratio:.1f}%")
    
    # Clear the original log file (keep empty file)
    with open(log_path, 'w') as f:
        f.write(f"# Log archived on {timestamp}\n")
        f.write(f"# Archive file: {archive_name}\n")
        f.write(f"{'='*60}\n\n")
    
    print(f"âœ“ Original log cleared")
    return True

def clean_old_archives(days=30):
    """Remove archives older than specified days"""
    if not ARCHIVE_DIR.exists():
        return
    
    print(f"\nðŸ§¹ Cleaning archives older than {days} days...")
    
    cutoff_time = datetime.now().timestamp() - (days * 24 * 60 * 60)
    removed_count = 0
    
    for archive_file in ARCHIVE_DIR.glob("*.log.gz"):
        if archive_file.stat().st_mtime < cutoff_time:
            archive_file.unlink()
            print(f"âœ“ Removed: {archive_file.name}")
            removed_count += 1
    
    if removed_count == 0:
        print("â„¹ï¸  No old archives to remove")
    else:
        print(f"âœ“ Removed {removed_count} old archive(s)")

def main():
    """Main function"""
    print("="*60)
    print("IntelliChat Log Archiver")
    print("="*60)
    print(f"Timestamp: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
    
    # Create archive directory
    create_archive_dir()
    
    # Archive each log file
    log_files = ["app.log", "error.log", "api.log"]
    archived_count = 0
    
    for log_file in log_files:
        log_path = LOGS_DIR / log_file
        if archive_log(log_path):
            archived_count += 1
    
    # Clean old archives
    clean_old_archives(days=30)
    
    # Summary
    print("\n" + "="*60)
    print(f"âœ… Archiving complete! {archived_count} log(s) archived")
    print("="*60)

if __name__ == "__main__":
    main()